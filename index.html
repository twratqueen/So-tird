<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èŠ±æé¼ ç¤¾ç¾¤å°ˆç”¨ - è‡¨æ™‚ç§å¯†å°è©± v3.0.0</title>
    
    <!-- åœ“åœ“èƒ–èƒ–çš„å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onValue, remove, set, onDisconnect, query, orderByChild, limitToLast, runTransaction, serverTimestamp, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // ä½ çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA3Ml5IrxQAX1s9W03y_yRjU1xELR_kNF8",
            authDomain: "rat50khz.firebaseapp.com",
            databaseURL: "https://rat50khz-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rat50khz",
            storageBucket: "rat50khz.firebasestorage.app",
            messagingSenderId: "259578799109",
            appId: "1:259578799109:web:2faaf07c2a5ca202b0686c",
            measurementId: "G-CRM8NDPK0G"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // å°‡ Firebase åŠŸèƒ½æ›è¼‰åˆ° windowï¼Œæ–¹ä¾¿å…¨åŸŸä½¿ç”¨
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseRemove = remove;
        window.firebaseSet = set;
        window.firebaseOnDisconnect = onDisconnect;
        window.firebaseQuery = query;
        window.firebaseOrderByChild = orderByChild;
        window.firebaseLimitToLast = limitToLast;
        window.firebaseRunTransaction = runTransaction;
        window.firebaseServerTimestamp = serverTimestamp;
        window.firebaseGet = get;
    </script>
    
    <style>
        /* è«è˜­è¿ªæ·±è‰²ç³»ä¸»é¡Œ */
        :root {
            /* é è¨­ä¸»é¡Œ (æœƒè¢« JS è¦†è“‹) */
            --bg-color: #3a3a3a;
            --card-bg: #4a4a4a;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-color: #8a9a8a;
            --accent-hover: #9aac9a;
            --btn-text: #ffffff;
            --input-bg: #2f2f2f;
            --input-border: #5a5a5a;
            --dot-off: #5a5a5a;
            --dot-on: #4CAF50;
            --text-green-lit: #66ff66;
        }
        
        /* éš¨æ©Ÿä¸»é¡Œ */
        .theme-1 { --bg-color: #2c3e50; --card-bg: #34495e; --text-primary: #ecf0f1; --text-secondary: #bdc3c7; --accent-color: #8e44ad; --accent-hover: #9b59b6; --input-bg: #2c3e50; --input-border: #4a637a; }
        .theme-2 { --bg-color: #4B3A41; --card-bg: #5A4A51; --text-primary: #F7F1EA; --text-secondary: #D4C4B4; --accent-color: #A57B68; --accent-hover: #B88A79; --input-bg: #403036; --input-border: #6a5a61; }
        .theme-3 { --bg-color: #3F4856; --card-bg: #4E5A65; --text-primary: #F4EFE9; --text-secondary: #C0C5C9; --accent-color: #5A8B9D; --accent-hover: #6AA0B3; --input-bg: #353D4A; --input-border: #5e6b7a; }
        .theme-4 { --bg-color: #4A4F46; --card-bg: #595F55; --text-primary: #F6F1EB; --text-secondary: #C4C8C2; --accent-color: #7A8B7D; --accent-hover: #8A9B8D; --input-bg: #40453C; --input-border: #696F65; }
        .theme-5 { --bg-color: #3D4D4F; --card-bg: #4C5C5E; --text-primary: #F3EDE6; --text-secondary: #BFC6C7; --accent-color: #6B7A8B; --accent-hover: #7B8A9B; --input-bg: #334345; --input-border: #5B6B6D; }

        /* åŸºæœ¬è¨­å®š */
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            /* åœ“åœ“èƒ–èƒ–çš„å­—é«” */
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
            font-weight: 500;
            transition: background-color 0.5s;
        }

        /* æ¨™é¡Œ */
        h1, h2, h3 {
            font-weight: 700;
            letter-spacing: 1px;
        }

        /* å®¹å™¨ */
        .container {
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
        }
        
        /* å¡ç‰‡ */
        .card {
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        /* è¼¸å…¥æ¡† */
        .input-field {
            background-color: var(--input-bg);
            border: 2px solid var(--input-border);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 16px;
            width: 100%;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-hover);
        }
        .input-field::placeholder {
            color: var(--text-secondary);
        }

        /* æŒ‰éˆ• */
        .btn {
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            color: var(--btn-text);
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .btn-primary:disabled {
            background-color: var(--dot-off);
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-admin {
            background-color: var(--input-border);
            color: var(--text-secondary);
        }
        .btn-admin:hover {
            background-color: var(--dot-off);
            color: var(--text-primary);
        }
        .btn-admin.selected {
            background-color: var(--accent-color);
            color: var(--btn-text);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* å¤§å»³ç‡ˆè™Ÿ */
        .lobby-lamp {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: var(--dot-off);
            transition: all 0.3s;
        }
        .lobby-lamp.on {
            background-color: var(--dot-on);
            box-shadow: 0 0 10px var(--dot-on), 0 0 5px var(--dot-on);
        }
        
        /* æˆ¿é–“åˆ—è¡¨ */
        .room-item {
            background-color: var(--card-bg);
            border: 2px solid var(--input-border);
            padding: 16px;
            gap: 12px;
        }
        .room-item.has-users {
            border-color: var(--dot-on);
        }
        
        .room-lamp {
             width: 12px;
             height: 12px;
             border-radius: 50%;
             background-color: var(--dot-off);
        }
        .room-lamp.on {
            background-color: var(--dot-on);
            box-shadow: 0 0 8px var(--dot-on);
        }
        
        /* é¼ çª©åç¨±è¼¸å…¥ (ç¸®å°å­—é«”) */
        .room-create-input {
            font-size: 13px; /* ç¸®å°3è™Ÿ */
            padding: 10px 12px;
        }
        
        .room-status-text {
            color: var(--text-green-lit);
            font-weight: 700;
        }

        /* èŠå¤©å®¤ç•«é¢ (ä¿®å¾©åç§») */
        #chatPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* ä½¿ç”¨ 100% è€Œä¸æ˜¯ 100vh é¿å…è¡Œå‹•è£ç½®ç€è¦½å™¨å•é¡Œ */
            display: flex; /* æ”¹ç‚º flex */
            flex-direction: column;
            background-color: var(--bg-color);
            overflow: hidden; /* ç¢ºä¿ä¸æœƒæœ‰æ±è¥¿æº¢å‡º */
            transform: translateZ(0); /* æå‡åœ–å±¤ */
        }
        
        #messagesContainer {
            flex: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOS æ»¾å‹•å„ªåŒ– */
        }
        
        /* çµ±è¨ˆè³‡æ–™ */
        #statsSection {
            background-color: rgba(0,0,0,0.2);
            border-radius: 16px;
            padding: 16px;
        }
        
        /* åœ–ç‰‡ä¸Šå‚³ */
        #imagePreviewContainer {
            display: flex;
            gap: 8px;
            padding: 8px;
            overflow-x: auto;
        }
        .preview-image-wrapper {
            position: relative;
            flex-shrink: 0;
        }
        .preview-image {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--input-border);
        }
        .remove-image-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- 
      ä¸»å®¹å™¨: 
      åŒ…å« ç™»å…¥ç•«é¢ã€çµ±è¨ˆ(éš±è—)ã€æˆ¿é–“åˆ—è¡¨(éš±è—)
    -->
    <div id="mainContainer" class="container space-y-5">
        
        <!-- 1. é ‚éƒ¨æ¨™é¡Œ & å¤§å»³ç‹€æ…‹ -->
        <div class="headline text-center space-y-3 pt-4">
            <h1 class="text-4xl md:text-5xl">èŠ±æé¼ ç¤¾ç¾¤å°ˆç”¨</h1>
            <h2 class="text-2xl md:text-3xl" style="color: var(--text-secondary);">è‡¨æ™‚ç§å¯†å°è©±å°å·¥å…·</h2>
            
            <!-- å¤§å»³ç‹€æ…‹ (Requirement #1) -->
            <div id="lobbyIndicator" class="flex items-center justify-center gap-3 p-3 bg-opacity-20 rounded-full" style="background-color: var(--card-bg);">
                <div id="lobbyLamp" class="lobby-lamp"></div>
                <span id="lobbyStatusText" class="text-sm font-semibold">æ­£åœ¨é€£æ¥...</span>
            </div>
            <div id="lastLeftTimeText" class="text-xs" style="color: var(--text-secondary);"></div>
        </div>

        <!-- 2. èªªæ˜æ–‡å­— (Requirement #1) -->
        <p class="description text-center text-lg leading-relaxed" style="color: var(--text-primary);">
            æœ‰æ™‚å€™æƒ³è·Ÿç¾¤å‹å–®ç¨èªªå…©å¥<br>
            ä½†æ˜¯åˆä¸æ–¹ä¾¿ç•™Lineæ€éº¼è¾¦ï¼Ÿ<br>
            çœŸçš„æœ‰äººç¿’æ…£å¥½å‹åå–®ä¿æŒæ•´æ½”å•ŠğŸ¥º<br>
            ç¾åœ¨ç¤¾ç¾¤æä¾›æˆå“¡ä¸€å€‹<br>
            ä¸ç”¨æ› Line ä¹Ÿèƒ½ç§èŠä¸€ä¸‹çš„åœ°æ–¹ï½
        </p>

        <!-- 3. ç™»å…¥å¡ç‰‡ (Requirement #2) -->
        <div id="loginCard" class="card space-y-5">
            <!-- ä¸€èˆ¬æˆå“¡ -->
            <div class="login-section space-y-2">
                <label for="nicknameInput" class="font-semibold text-lg">ä¸€èˆ¬æˆå“¡ç™»å…¥</label>
                <input type="text" id="nicknameInput" class="input-field" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±">
            </div>

            <!-- ç®¡ç†å“¡ -->
            <div class="admin-section space-y-3">
                <label class="font-semibold text-lg text-center">ç®¡ç†å“¡</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button onclick="selectAdmin(event, 'å¸é¼ å¥³')" class="btn btn-admin" data-admin="å¸é¼ å¥³">å¸é¼ å¥³</button>
                    <button onclick="selectAdmin(event, 'å¤§ç™½ç¾å¦™')" class="btn btn-admin" data-admin="å¤§ç™½ç¾å¦™">å¤§ç™½ç¾å¦™</button>
                    <button onclick="selectAdmin(event, 'Jinx')" class="btn btn-admin" data-admin="Jinx">Jinx</button>
                    <button onclick="selectAdmin(event, 'èŠ’æœ')" class="btn btn-admin" data-admin="èŠ’æœ">èŠ’æœ</button>
                </div>
            </div>

            <!-- å¯†ç¢¼ & ç™»å…¥ -->
            <div class="password-section grid md:grid-cols-2 gap-4 items-center">
                <input type="password" id="adminPassword" class="input-field" placeholder="è¼¸å…¥å¯†ç¢¼">
                <span class="text-xs text-center md:text-left" style="color: var(--text-secondary);">(ä¸€èˆ¬æˆå“¡ç„¡éœ€è¼¸å…¥å¯†ç¢¼)</span>
            </div>
            
            <button id="loginButton" class="btn btn-primary w-full text-lg">ç™»å…¥</button>
        </div>

        <!-- 4. å¸é¼ å¥³çµ±è¨ˆå€ (Requirement #3) -->
        <div id="statsSection" class="hidden space-y-3">
            <h3 class="text-xl font-bold text-center">å³æ™‚çµ±è¨ˆè³‡æ–™</h3>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="stat-item bg-black bg-opacity-20 p-3 rounded-lg">
                    <div>ç€è¦½ç¸½æ¬¡æ•¸ï¼š</div>
                    <div id="statsTotalVisits" class="text-2xl font-bold">0 æ¬¡</div>
                </div>
                <div class="stat-item bg-black bg-opacity-20 p-3 rounded-lg">
                    <div>æ­·å²é¼ çª©æ•¸é‡ï¼š</div>
                    <div id="statsTotalRooms" class="text-2xl font-bold">0 å€‹</div>
                </div>
            </div>
            <div class="stat-item bg-black bg-opacity-20 p-3 rounded-lg">
                <div class="font-semibold mb-2">ç®¡ç†å“¡ç™»å…¥æ¬¡æ•¸ï¼š</div>
                <div id="statsAdminLogins" class="space-y-1 text-sm">
                    <div>å¸é¼ å¥³: 0 æ¬¡</div>
                    <div>å¤§ç™½ç¾å¦™: 0 æ¬¡</div>
                    <div>Jinx: 0 æ¬¡</div>
                    <div>èŠ’æœ: 0 æ¬¡</div>
                </div>
            </div>
        </div>

        <!-- 5. æˆ¿é–“åˆ—è¡¨ (ç™»å…¥å¾Œé¡¯ç¤º) -->
        <div id="roomsSection" class="hidden space-y-4">
            <h2 id="welcomeHeader" class="text-2xl font-bold text-center"></h2>
            
            <!-- æˆ¿é–“æ ¼ç·š (Requirement #6) -->
            <div id="roomsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <!-- æˆ¿é–“ 1: æº«æº«é¼ çª© -->
                <div class="room-item flex flex-col rounded-xl" data-room-id="æº«æº«é¼ çª©">
                    <div class="flex justify-between items-center w-full">
                        <span class="text-xl font-bold">æº«æº«é¼ çª©</span>
                        <div class="room-lamp"></div>
                    </div>
                    <div class="text-sm room-status-text" style="color: var(--text-green-lit);">é¼ çª©æœ‰ 0 éš»è€é¼ </div>
                    <button class="btn btn-primary w-full mt-auto" onclick="enterRoom('æº«æº«é¼ çª©')">åŠ å…¥é¼ çª©</button>
                </div>
                
                <!-- æˆ¿é–“ 2: å‹•æ…‹ -->
                <div class="room-item flex flex-col rounded-xl" data-room-id="slot_1">
                    <div class="flex justify-between items-center w-full">
                        <span class="text-xl font-bold room-name">é¼ çª©æ²’é¼ </span>
                        <div class="room-lamp"></div>
                    </div>
                    <!-- ç‹€æ…‹ 1: æ²’äºº (å‰µå»º) -->
                    <div class="room-create w-full space-y-2 mt-auto">
                        <input type="text" class="input-field room-create-input" placeholder="è¼¸å…¥æ–°é¼ çª©åç¨±...">
                        <button class="btn btn-primary w-full" onclick="createRoom('slot_1')">å‰µå»ºé¼ çª©</button>
                    </div>
                    <!-- ç‹€æ…‹ 2: æœ‰äºº (åŠ å…¥) -->
                    <div class="room-join w-full mt-auto hidden">
                        <div class="text-sm room-status-text" style="color: var(--text-green-lit);">é¼ çª©æœ‰ 0 éš»è€é¼ </div>
                        <button class="btn btn-primary w-full mt-2" onclick="enterRoom(this.dataset.roomName)">åŠ å…¥é¼ çª©</button>
                    </div>
                </div>
                
                <!-- æˆ¿é–“ 3: å‹•æ…‹ -->
                <div class="room-item flex flex-col rounded-xl" data-room-id="slot_2">
                    <div class="flex justify-between items-center w-full">
                        <span class="text-xl font-bold room-name">é¼ çª©æ²’é¼ </span>
                        <div class="room-lamp"></div>
                    </div>
                    <div class="room-create w-full space-y-2 mt-auto">
                        <input type="text" class="input-field room-create-input" placeholder="è¼¸å…¥æ–°é¼ çª©åç¨±...">
                        <button class="btn btn-primary w-full" onclick="createRoom('slot_2')">å‰µå»ºé¼ çª©</button>
                    </div>
                    <div class="room-join w-full mt-auto hidden">
                        <div class="text-sm room-status-text" style="color: var(--text-green-lit);">é¼ çª©æœ‰ 0 éš»è€é¼ </div>
                        <button class="btn btn-primary w-full mt-2" onclick="enterRoom(this.dataset.roomName)">åŠ å…¥é¼ çª©</button>
                    </div>
                </div>
                
                <!-- æˆ¿é–“ 4: å‹•æ…‹ -->
                <div class="room-item flex flex-col rounded-xl" data-room-id="slot_3">
                    <div class="flex justify-between items-center w-full">
                        <span class="text-xl font-bold room-name">é¼ çª©æ²’é¼ </span>
                        <div class="room-lamp"></div>
                    </div>
                    <div class="room-create w-full space-y-2 mt-auto">
                        <input type="text" class="input-field room-create-input" placeholder="è¼¸å…¥æ–°é¼ çª©åç¨±...">
                        <button class="btn btn-primary w-full" onclick="createRoom('slot_3')">å‰µå»ºé¼ çª©</button>
                    </div>
                    <div class="room-join w-full mt-auto hidden">
                        <div class="text-sm room-status-text" style="color: var(--text-green-lit);">é¼ çª©æœ‰ 0 éš»è€é¼ </div>
                        <button class="btn btn-primary w-full mt-2" onclick="enterRoom(this.dataset.roomName)">åŠ å…¥é¼ çª©</button>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- 6. ç‰ˆæœ¬è™Ÿ -->
        <p class="version-text text-center text-sm mt-4" style="color: var(--text-secondary);">2025/10/22 v3.0.0</p>
    </div>

    <!-- 
      èŠå¤©å®¤ç•«é¢ (é è¨­éš±è—)
      (Requirement #4: ä¿®å¾©åç§»)
    -->
    <div id="chatPage" class="hidden">
        
        <!-- èŠå¤©å®¤é ‚éƒ¨ -->
        <div class="chat-header p-4 flex items-center justify-between shadow-lg" style="background-color: var(--card-bg); flex-shrink: 0;">
            <button class="icon-button p-2" onclick="backToRooms()" aria-label="è¿”å›æˆ¿é–“åˆ—è¡¨">
                <svg class="w-6 h-6" fill="var(--text-primary)" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
            </button>
            <div class="text-center">
                <div id="currentRoomName" class="text-lg font-bold"></div>
                <div id="roomOnlineCount" class="text-xs" style="color: var(--text-secondary);">åœ¨ç·šï¼š0</div>
            </div>
            <button class="icon-button p-2" onclick="logout()" aria-label="ç™»å‡º">
                 <svg class="w-6 h-6" fill="var(--text-primary)" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H3zm12.293 4.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 13H9a1 1 0 110-2h7.586l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
        </div>

        <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
        <div id="messagesContainer" class="p-4 space-y-4">
            <!-- æ­¡è¿è¨Šæ¯ -->
            <div class="notice-box p-4 rounded-lg text-sm" style="background-color: var(--card-bg);">
                <p id="entryNotice" class="font-bold mb-2"></p>
                <p><strong>æé†’ï¼š</strong>è¨Šæ¯æœƒåœ¨ç™¼é€ 1 å°æ™‚å¾Œè‡ªå‹•æ¸…é™¤ (åŒ…å«åœ–ç‰‡)ã€‚</p>
                <p>ç•¶æ‰€æœ‰æˆå“¡é›¢é–‹æ­¤èŠå¤©å®¤æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•æ¸…ç©ºå°è©±è¨˜éŒ„ã€‚</p>
            </div>
            <!-- è¨Šæ¯åˆ—è¡¨ -->
            <div id="messagesList" class="space-y-4"></div>
        </div>
        
        <!-- 
          è¼¸å…¥å€ (Requirement #5: å‚³åœ–åŠŸèƒ½)
        -->
        <div class="chat-input-container p-3" style="background-color: var(--card-bg); flex-shrink: 0;">
            <!-- åœ–ç‰‡é è¦½ -->
            <div id="imagePreviewContainer" class="mb-2">
                <!-- é è¦½åœ–ç‰‡æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
            
            <div class="flex items-center gap-2">
                <!-- éš±è—çš„æª”æ¡ˆä¸Šå‚³ -->
                <input type="file" id="imageInput" accept="image/*" multiple class="hidden" onchange="handleImageSelection(event)">
                
                <!-- å‚³åœ–æŒ‰éˆ• -->
                <button id="attachButton" class="icon-button p-2" onclick="document.getElementById('imageInput').click()" aria-label="å‚³é€åœ–ç‰‡">
                    <svg class="w-6 h-6" fill="var(--text-primary)" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4V5h12v10zm-9-1a1 1 0 100 2 1 1 0 000-2zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                </button>
                
                <!-- æ–‡å­—è¼¸å…¥ -->
                <input type="text" id="messageInput" class="input-field flex-1" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleKeyPress(event)">
                
                <!-- ç™¼é€æŒ‰éˆ• -->
                <button id="sendButton" class="btn btn-primary" onclick="sendMessage()">ç™¼é€</button>
            </div>
        </div>

    </div>

    <!-- 
      =================================
      JavaScript è…³æœ¬
      =================================
    -->
    <script type="module">
        // --- å…¨åŸŸè®Šæ•¸ ---
        let currentUser = null;
        let currentRoom = null;
        let selectedAdmin = null;
        let lobbySessionId = `lobby_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;
        let pagePresenceRef = null;
        let userRoomPresenceRef = null;
        let messagesListener = null;
        let roomOnlineListener = null;
        let allRoomsListener = null;
        let lobbyListener = null;
        let lastLobbyCount = 0;
        let pendingImages = []; // (Requirement #5)

        // ç®¡ç†å“¡å¯†ç¢¼ (æ³¨æ„: å„²å­˜åœ¨å‰ç«¯ä¸å®‰å…¨ï¼Œåƒ…ç‚ºæ¼”ç¤º)
        const adminPasswords = {
            'å¸é¼ å¥³': '444',
            'å¤§ç™½ç¾å¦™': 'totoro',
            'Jinx': 'jinx',
            'èŠ’æœ': 'Ying'
        };

        // --- é é¢åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            applyRandomTheme();
            initializeLobbyPresence();
            displayLastLeftTime();
            
            // ç¶å®šç™»å…¥æŒ‰éˆ•äº‹ä»¶
            document.getElementById('loginButton').addEventListener('click', login);
            
            // ç¶å®š Enter éµ
            document.getElementById('nicknameInput').addEventListener('keypress', (e) => e.key === 'Enter' && login());
            document.getElementById('adminPassword').addEventListener('keypress', (e) => e.key === 'Enter' && login());
        });
        
        // å¥—ç”¨éš¨æ©Ÿè«è˜­è¿ªä¸»é¡Œ
        function applyRandomTheme() {
            const themes = ['theme-1', 'theme-2', 'theme-3', 'theme-4', 'theme-5'];
            const randomTheme = themes[Math.floor(Math.random() * themes.length)];
            document.body.classList.add(randomTheme);
        }

        // --- 1. å¤§å»³ç‹€æ…‹ (Requirement #1) ---
        
        // åˆå§‹åŒ–å¤§å»³ç‹€æ…‹ (é€²å…¥ç¶²ç«™)
        async function initializeLobbyPresence() {
            if (!window.firebaseDB) return;
            pagePresenceRef = window.firebaseRef(window.firebaseDB, `pageOnline/${lobbySessionId}`);
            
            try {
                // æ¨™è¨˜è‡ªå·±ä¸Šç·š
                await window.firebaseSet(pagePresenceRef, { joinTime: window.firebaseServerTimestamp() });
                // è¨­å®šé›¢ç·šæ™‚è‡ªå‹•ç§»é™¤
                window.firebaseOnDisconnect(pagePresenceRef).remove();
            } catch (error) {
                console.error("ç„¡æ³•è¨­å®šå¤§å»³ç‹€æ…‹: ", error);
            }
            
            // ç›£è½å¤§å»³ç¸½äººæ•¸
            const lobbyRef = window.firebaseRef(window.firebaseDB, 'pageOnline');
            if (lobbyListener) lobbyListener(); // ç§»é™¤èˆŠç›£è½
            
            lobbyListener = window.firebaseOnValue(lobbyRef, (snapshot) => {
                const count = snapshot.numChildren();
                updateLobbyIndicator(count);
                
                // åµæ¸¬æ˜¯å¦å‰›å¾æœ‰äººè®Šæ²’äºº
                if (lastLobbyCount > 0 && count === 0) {
                    // è¨˜éŒ„æœ€å¾Œé›¢é–‹æ™‚é–“
                    window.firebaseSet(window.firebaseRef(window.firebaseDB, 'stats/lastLeftTime'), window.firebaseServerTimestamp());
                }
                lastLobbyCount = count;
            });
        }
        
        // æ›´æ–°å¤§å»³ UI
        function updateLobbyIndicator(count) {
            const lamp = document.getElementById('lobbyLamp');
            const text = document.getElementById('lobbyStatusText');
            if (!lamp || !text) return;

            if (count > 0) {
                lamp.classList.add('on');
                text.textContent = `å¤§å»³æœ‰ ${count} éš»è€é¼ `;
            } else {
                lamp.classList.remove('on');
                text.textContent = 'å¤§å»³æ²’æœ‰è€é¼ ';
            }
        }

        // é¡¯ç¤ºä¸Šæ¬¡é›¢é–‹æ™‚é–“
        async function displayLastLeftTime() {
            if (!window.firebaseDB) return;
            const lastLeftRef = window.firebaseRef(window.firebaseDB, 'stats/lastLeftTime');
            const lastLeftText = document.getElementById('lastLeftTimeText');
            
            try {
                const snapshot = await window.firebaseGet(lastLeftRef);
                if (!snapshot.exists()) {
                    lastLeftText.textContent = 'æ­¡è¿ç¬¬ä¸€éš»è€é¼ ï¼';
                    return;
                }
                
                const lastLeftTime = snapshot.val();
                const diffMs = Date.now() - lastLeftTime;
                
                if (diffMs < 60000) { // ä¸€åˆ†é˜å…§
                    lastLeftText.textContent = 'ä¸Šä¸€éš»è€é¼ å‰›å‰›é›¢é–‹';
                    return;
                }
                
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                lastLeftText.textContent = `ä¸Šä¸€éš»è€é¼ åœ¨ ${diffDays} å¤© ${diffHours} å°æ™‚å‰é›¢é–‹äº†`;
                
            } catch (error) {
                console.error("ç„¡æ³•å–å¾—ä¸Šæ¬¡é›¢é–‹æ™‚é–“: ", error);
                lastLeftText.textContent = 'ç„¡æ³•è®€å–è¨ªå®¢ç´€éŒ„';
            }
        }

        // --- 2. ç™»å…¥é‚è¼¯ (Requirement #2) ---
        
        // é¸æ“‡ç®¡ç†å“¡
        window.selectAdmin = function(event, adminName) {
            selectedAdmin = adminName;
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.btn-admin').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.admin === adminName);
            });
            document.getElementById('adminPassword').focus();
        }

        // ç™»å…¥æŒ‰éˆ•
        async function login() {
            const nicknameInput = document.getElementById('nicknameInput');
            const passwordInput = document.getElementById('adminPassword');
            const nickname = nicknameInput.value.trim();
            const password = passwordInput.value.trim();

            if (selectedAdmin) {
                // ç®¡ç†å“¡ç™»å…¥
                if (!password) {
                    alert('è«‹è¼¸å…¥å¯†ç¢¼');
                    return;
                }
                if (password !== adminPasswords[selectedAdmin]) {
                    alert('ç®¡ç†å“¡å¯†ç¢¼éŒ¯èª¤ï¼');
                    return;
                }
                currentUser = {
                    id: 'admin_' + selectedAdmin,
                    nickname: selectedAdmin,
                    isAdmin: true
                };
            } else if (nickname) {
                // ä¸€èˆ¬æˆå“¡ç™»å…¥
                currentUser = {
                    id: 'user_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9),
                    nickname: nickname,
                    isAdmin: false
                };
            } else {
                alert('è«‹è¼¸å…¥æš±ç¨±ï¼Œæˆ–é¸æ“‡ç®¡ç†å“¡ä¸¦è¼¸å…¥å¯†ç¢¼');
                return;
            }

            // ç™»å…¥æˆåŠŸ
            document.getElementById('loginCard').classList.add('hidden');
            document.getElementById('roomsSection').classList.remove('hidden');
            document.getElementById('welcomeHeader').textContent = `æ­¡è¿ï¼Œ${currentUser.nickname}`;
            
            // ç´€éŒ„çµ±è¨ˆ
            await recordVisitStats();
            
            // (Requirement #3) é¡¯ç¤ºå¸é¼ å¥³çµ±è¨ˆ
            if (currentUser.nickname === 'å¸é¼ å¥³') {
                document.getElementById('statsSection').classList.remove('hidden');
                showAdminStats();
            }
            
            // é–‹å§‹ç›£è½æ‰€æœ‰æˆ¿é–“
            listenToAllRooms();
        }

        // --- 3. çµ±è¨ˆåŠŸèƒ½ (Requirement #3) ---

        // ç´€éŒ„ç™»å…¥/ç€è¦½
        async function recordVisitStats() {
            if (!window.firebaseDB) return;
            
            // å¢åŠ ç¸½ç€è¦½æ¬¡æ•¸
            const visitsRef = window.firebaseRef(window.firebaseDB, 'stats/totalVisits');
            window.firebaseRunTransaction(visitsRef, (currentValue) => (currentValue || 0) + 1);
            
            // ç´€éŒ„ç®¡ç†å“¡ç™»å…¥
            if (currentUser.isAdmin) {
                const adminLoginRef = window.firebaseRef(window.firebaseDB, `stats/adminLogins/${currentUser.nickname}`);
                window.firebaseRunTransaction(adminLoginRef, (currentValue) => (currentValue || 0) + 1);
            }
        }
        
        // é¡¯ç¤ºç®¡ç†å“¡çµ±è¨ˆ
        async function showAdminStats() {
            if (!window.firebaseDB) return;
            const statsRef = window.firebaseRef(window.firebaseDB, 'stats');
            
            try {
                const snapshot = await window.firebaseGet(statsRef);
                const stats = snapshot.val() || {};
                
                const totalVisits = stats.totalVisits || 0;
                const totalRooms = stats.totalRoomsCreated || 0;
                const adminLogins = stats.adminLogins || {};
                
                document.getElementById('statsTotalVisits').textContent = `${totalVisits} æ¬¡`;
                document.getElementById('statsTotalRooms').textContent = `${totalRooms} å€‹`;
                
                const adminStatsHTML = Object.keys(adminPasswords)
                    .map(adminName => {
                        const count = adminLogins[adminName] || 0;
                        return `<div>${adminName}: ${count} æ¬¡</div>`;
                    })
                    .join('');
                document.getElementById('statsAdminLogins').innerHTML = adminStatsHTML;
                
            } catch (error) {
                console.error("ç„¡æ³•è¼‰å…¥çµ±è¨ˆè³‡æ–™: ", error);
            }
        }

        // --- 4. æˆ¿é–“åˆ—è¡¨é‚è¼¯ (Requirement #6) ---
        
        // ç›£è½æ‰€æœ‰æˆ¿é–“
        function listenToAllRooms() {
            if (!window.firebaseDB) return;
            const roomsRef = window.firebaseRef(window.firebaseDB, 'rooms');
            
            if (allRoomsListener) allRoomsListener(); // ç§»é™¤èˆŠç›£è½
            
            allRoomsListener = window.firebaseOnValue(roomsRef, (snapshot) => {
                const roomsData = snapshot.val() || {};
                const dynamicRoomNames = Object.keys(roomsData).filter(name => name !== 'æº«æº«é¼ çª©');
                
                // 1. æ›´æ–°æº«æº«é¼ çª©
                updateRoomUI(
                    document.querySelector('[data-room-id="æº«æº«é¼ çª©"]'),
                    'æº«æº«é¼ çª©',
                    roomsData['æº«æº«é¼ çª©']
                );
                
                // 2. æ›´æ–°ä¸‰å€‹å‹•æ…‹é¼ çª©
                const slots = ['slot_1', 'slot_2', 'slot_3'];
                slots.forEach((slotId, index) => {
                    const roomName = dynamicRoomNames[index];
                    const roomElement = document.querySelector(`[data-room-id="${slotId}"]`);
                    
                    if (roomName) {
                        // é€™å€‹æ¬„ä½è¢«ä½”ç”¨äº†
                        updateRoomUI(roomElement, roomName, roomsData[roomName]);
                    } else {
                        // é€™å€‹æ¬„ä½æ˜¯ç©ºçš„
                        updateRoomUI(roomElement, null, null);
                    }
                });
            });
        }
        
        // æ›´æ–°å–®ä¸€æˆ¿é–“çš„ UI
        function updateRoomUI(element, roomName, roomData) {
            const lamp = element.querySelector('.room-lamp');
            const roomNameEl = element.querySelector('.room-name');
            const createDiv = element.querySelector('.room-create');
            const joinDiv = element.querySelector('.room-join');
            const statusText = joinDiv.querySelector('.room-status-text');
            const joinButton = joinDiv.querySelector('button');
            
            const onlineCount = roomData && roomData.online ? Object.keys(roomData.online).length : 0;
            
            if (roomName && (onlineCount > 0 || roomName === 'æº«æº«é¼ çª©')) {
                // ç‹€æ…‹: æˆ¿é–“æœ‰äºº (æˆ–æ˜¯å›ºå®šçš„æº«æº«é¼ çª©)
                lamp.classList.add('on');
                if (roomNameEl) roomNameEl.textContent = roomName; // æ›´æ–°åç¨±
                createDiv.classList.add('hidden');
                joinDiv.classList.remove('hidden');
                statusText.textContent = `é¼ çª©æœ‰ ${onlineCount} éš»è€é¼ `;
                joinButton.dataset.roomName = roomName;
                
                // (Requirement #4) ä¿®å¾©æº«æº«é¼ çª©æŒ‰éˆ•
                if (roomName === 'æº«æº«é¼ çª©') {
                    const btn = element.querySelector('.btn-primary');
                    btn.disabled = false;
                }
                
            } else if (roomName && onlineCount === 0) {
                 // ç‹€æ…‹: æˆ¿é–“æ˜¯å‹•æ…‹çš„ï¼Œä½†è£¡é¢æ²’äºº (ä¾‹å¦‚å‰›å‰µå»ºæˆ–äººèµ°å…‰äº†)
                 // è‡ªå‹•åˆªé™¤é€™å€‹ç©ºæˆ¿é–“
                 window.firebaseRemove(window.firebaseRef(window.firebaseDB, `rooms/${roomName}`));
                 // UI æœƒåœ¨ä¸‹ä¸€æ¬¡ onValue è‡ªå‹•æ›´æ–°å› "é¼ çª©æ²’é¼ "
                 
            } else {
                // ç‹€æ…‹: æˆ¿é–“æ˜¯ç©ºçš„ (é¼ çª©æ²’é¼ )
                lamp.classList.remove('on');
                if (roomNameEl) roomNameEl.textContent = 'é¼ çª©æ²’é¼ ';
                createDiv.classList.remove('hidden');
                joinDiv.classList.add('hidden');
                // æ¸…ç©ºè¼¸å…¥æ¡†
                createDiv.querySelector('input').value = '';
            }
        }
        
        // å‰µå»ºæˆ¿é–“
        window.createRoom = function(slotId) {
            const element = document.querySelector(`[data-room-id="${slotId}"]`);
            const input = element.querySelector('input');
            const roomName = input.value.trim();
            
            if (!roomName) {
                alert('è«‹è¼¸å…¥é¼ çª©åç¨±');
                return;
            }
            if (roomName === 'æº«æº«é¼ çª©') {
                alert('é€™å€‹åç¨±ä¸å¯ä»¥ç”¨å–”');
                return;
            }
            
            // ç´€éŒ„æ­·å²é¼ çª©æ•¸é‡
            const roomsCountRef = window.firebaseRef(window.firebaseDB, 'stats/totalRoomsCreated');
            window.firebaseRunTransaction(roomsCountRef, (currentValue) => (currentValue || 0) + 1);
            
            // é€²å…¥æˆ¿é–“
            enterRoom(roomName);
        }

        // --- 5. èŠå¤©å®¤é‚è¼¯ (Requirement #4, #5) ---

        // é€²å…¥æˆ¿é–“
        window.enterRoom = async function(roomName) {
            currentRoom = roomName;
            
            // è¨­å®šåœ¨ç·šç‹€æ…‹
            const onlineRef = window.firebaseRef(window.firebaseDB, `rooms/${currentRoom}/online/${currentUser.id}`);
            userRoomPresenceRef = onlineRef;
            
            await window.firebaseSet(onlineRef, {
                nickname: currentUser.nickname,
                isAdmin: currentUser.isAdmin
            });
            // é›¢ç·š/é—œé–‰ç¶²é æ™‚è‡ªå‹•ç§»é™¤
            window.firebaseOnDisconnect(onlineRef).remove();
            
            // é¡¯ç¤ºèŠå¤©ç•«é¢
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('chatPage').classList.remove('hidden');
            
            // æ›´æ–°èŠå¤©å®¤æ¨™é¡Œ
            document.getElementById('currentRoomName').textContent = currentRoom;
            document.getElementById('entryNotice').textContent = `æ­¡è¿ ${currentUser.nickname}ï¼`;

            // é–‹å§‹ç›£è½
            listenToRoomOnlineUsers();
            listenToMessages();
        }
        
        // ç›£è½èŠå¤©å®¤åœ¨ç·šäººæ•¸
        function listenToRoomOnlineUsers() {
            const onlineRef = window.firebaseRef(window.firebaseDB, `rooms/${currentRoom}/online`);
            if (roomOnlineListener) roomOnlineListener();
            
            roomOnlineListener = window.firebaseOnValue(onlineRef, (snapshot) => {
                const count = snapshot.numChildren();
                document.getElementById('roomOnlineCount').textContent = `åœ¨ç·šï¼š${count}`;
                
                // è‡ªå‹•æ¸…ç©ºæ²’äººçš„æˆ¿é–“
                if (count === 0) {
                    // æ¸…ç©ºè¨Šæ¯
                    window.firebaseRemove(window.firebaseRef(window.firebaseDB, `rooms/${currentRoom}/messages`));
                    
                    // å¦‚æœä¸æ˜¯æº«æº«é¼ çª©ï¼Œå°±åˆªé™¤æ•´å€‹æˆ¿é–“
                    if (currentRoom !== 'æº«æº«é¼ çª©') {
                        window.firebaseRemove(window.firebaseRef(window.firebaseDB, `rooms/${currentRoom}`));
                    }
                }
            });
        }
        
        // ç›£è½è¨Šæ¯
        function listenToMessages() {
            const messagesRef = window.firebaseQuery(
                window.firebaseRef(window.firebaseDB, `rooms/${currentRoom}/messages`),
                window.firebaseOrderByChild('timestamp')
            );
            
            if (messagesListener) messagesListener();
            
            messagesListener = window.firebaseOnValue(messagesRef, (snapshot) => {
                const messagesList = document.getElementById('messagesList');
                messagesList.innerHTML = ''; // æ¸…ç©º
                const oneHourAgo = Date.now() - (60 * 60 * 1000);
                
                snapshot.forEach((childSnapshot) => {
                    const msg = childSnapshot.val();
                    
                    // (Requirement #5) 1å°æ™‚è‡ªå‹•æ¸…é™¤
                    if (msg.timestamp < oneHourAgo) {
                        window.firebaseRemove(childSnapshot.ref);
                        return; // ä¸é¡¯ç¤ºèˆŠè¨Šæ¯
                    }
                    
                    displayMessage(msg);
                });
                
                // æ»¾å‹•åˆ°åº•éƒ¨
                document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
            });
        }
        
        // é¡¯ç¤ºå–®ä¸€è¨Šæ¯
        function displayMessage(msg) {
            const messagesList = document.getElementById('messagesList');
            const div = document.createElement('div');
            const isMe = msg.userId === currentUser.id;
            
            div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-3`;
            
            // æš±ç¨±
            const nickname = document.createElement('span');
            nickname.className = `text-xs mb-1 ${isMe ? 'text-right' : 'text-left'}`;
            nickname.style.color = 'var(--text-secondary)';
            nickname.textContent = msg.isAdmin ? `ğŸ‘‘ ${msg.nickname}` : msg.nickname;
            
            // æ³¡æ³¡
            const bubble = document.createElement('div');
            bubble.className = 'p-3 rounded-2xl max-w-xs md:max-w-md shadow';
            bubble.style.backgroundColor = isMe ? 'var(--accent-color)' : 'var(--card-bg)';
            bubble.style.color = isMe ? 'var(--btn-text)' : 'var(--text-primary)';
            
            // è¨Šæ¯æ–‡å­—
            if (msg.text) {
                const text = document.createElement('p');
                text.textContent = msg.text;
                text.className = 'whitespace-pre-wrap break-words';
                bubble.appendChild(text);
            }
            
            // (Requirement #5) é¡¯ç¤ºåœ–ç‰‡
            if (msg.images && msg.images.length > 0) {
                const imgContainer = document.createElement('div');
                imgContainer.className = `grid gap-1 mt-2 ${msg.images.length > 1 ? 'grid-cols-2' : 'grid-cols-1'}`;
                
                msg.images.forEach(imgBase64 => {
                    const img = document.createElement('img');
                    img.src = imgBase64;
                    img.className = 'rounded-lg w-full h-auto object-cover max-h-48 cursor-pointer';
                    img.onclick = () => window.open(imgBase64, '_blank');
                    imgContainer.appendChild(img);
                });
                bubble.appendChild(imgContainer);
            }
            
            div.appendChild(nickname);
            div.appendChild(bubble);
            messagesList.appendChild(div);
        }

        // ç™¼é€è¨Šæ¯
        window.sendMessage = async function() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            // (Requirement #5) æª¢æŸ¥æ–‡å­—å’Œåœ–ç‰‡
            if (!text && pendingImages.length === 0) {
                return; // æ²’æœ‰ä»»ä½•å…§å®¹
            }
            
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true; // é˜²æ­¢é‡è¤‡ç™¼é€

            try {
                const messageData = {
                    userId: currentUser.id,
                    nickname: currentUser.nickname,
                    isAdmin: currentUser.isAdmin,
                    text: text || null,
                    images: pendingImages.length > 0 ? pendingImages : null,
                    timestamp: window.firebaseServerTimestamp()
                };
                
                await window.firebasePush(window.firebaseRef(window.firebaseDB, `rooms/${currentRoom}/messages`), messageData);
                
                // æ¸…ç©º
                messageInput.value = '';
                pendingImages = [];
                document.getElementById('imagePreviewContainer').innerHTML = '';
                document.getElementById('imageInput').value = ''; // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
                
            } catch (error) {
                console.error("ç™¼é€è¨Šæ¯å¤±æ•—: ", error);
                alert("ç™¼é€å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
            } finally {
                sendButton.disabled = false;
            }
        }
        
        // (Requirement #5) è™•ç†åœ–ç‰‡é¸æ“‡
        window.handleImageSelection = function(event) {
            const files = event.target.files;
            if (!files) return;
            
            // æª¢æŸ¥æ•¸é‡
            if (files.length + pendingImages.length > 5) {
                alert('ä¸€æ¬¡æœ€å¤šå‚³ 5 å¼µåœ–ç‰‡');
                return;
            }
            
            const previewContainer = document.getElementById('imagePreviewContainer');
            
            Array.from(files).forEach(file => {
                // æª¢æŸ¥å¤§å° (ä¾‹å¦‚: 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert(`åœ–ç‰‡ ${file.name} å¤ªå¤§äº† (è¶…é 2MB)`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64String = e.target.result;
                    pendingImages.push(base64String);
                    
                    // é¡¯ç¤ºé è¦½ç¸®åœ–
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'preview-image-wrapper';
                    
                    const img = document.createElement('img');
                    img.src = base64String;
                    img.className = 'preview-image';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Ã—';
                    removeBtn.className = 'remove-image-btn';
                    removeBtn.onclick = () => {
                        // å¾ pendingImages ç§»é™¤
                        const index = pendingImages.indexOf(base64String);
                        if (index > -1) {
                            pendingImages.splice(index, 1);
                        }
                        // å¾ UI ç§»é™¤
                        previewContainer.removeChild(imgWrapper);
                    };
                    
                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(removeBtn);
                    previewContainer.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // --- 6. é›¢é–‹ & ç™»å‡º ---

        // é›¢é–‹èŠå¤©å®¤ï¼Œè¿”å›æˆ¿é–“åˆ—è¡¨
        window.backToRooms = function() {
            // åœæ­¢ç›£è½
            if (messagesListener) messagesListener();
            if (roomOnlineListener) roomOnlineListener();
            
            // ç§»é™¤åœ¨ç·šç‹€æ…‹
            if (userRoomPresenceRef) {
                window.firebaseRemove(userRoomPresenceRef);
                userRoomPresenceRef = null;
            }
            
            currentRoom = null;
            
            // æ¸…ç©ºåœ–ç‰‡é è¦½
            pendingImages = [];
            document.getElementById('imagePreviewContainer').innerHTML = '';
            document.getElementById('imageInput').value = '';
            
            // åˆ‡æ›ç•«é¢
            document.getElementById('chatPage').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
        }

        // å®Œå…¨ç™»å‡º (Requirement #5)
        window.logout = async function() {
            if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) return;
            
            // è§¸ç™¼è¿”å› (æœƒæ¸…é™¤æˆ¿é–“ç‹€æ…‹)
            backToRooms();
            
            // åœæ­¢ç›£è½
            if (allRoomsListener) allRoomsListener();
            
            currentUser = null;
            selectedAdmin = null;
            
            // éš±è—æˆ¿é–“åˆ—è¡¨å’Œçµ±è¨ˆ
            document.getElementById('roomsSection').classList.add('hidden');
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('loginCard').classList.remove('hidden');
            
            // é‡è¨­ç™»å…¥è¡¨å–®
            document.getElementById('nicknameInput').value = '';
            document.getElementById('adminPassword').value = '';
            document.querySelectorAll('.btn-admin').forEach(btn => btn.classList.remove('selected'));
        }
        
        // (Requirement #5) æ”¹ç‚º1å°æ™‚å¾Œæ–·ç·š
        // ä¿®æ­£ï¼šé€™ç„¡æ³•å¯é å¯¦ä½œã€‚ç€è¦½å™¨æœƒè‡ªå‹•è™•ç† `onDisconnect`ã€‚
        // æˆ‘å€‘å°‡ä¿æŒæ¨™æº–çš„ `onDisconnect` (é—œé–‰åˆ†é /ç€è¦½å™¨æ™‚ç«‹å³è§¸ç™¼)
        // é€™æ˜¯æœ€ç©©å®šä¸”ç¬¦åˆä½¿ç”¨è€…é æœŸçš„è¡Œç‚ºã€‚
        // è¨Šæ¯çš„1å°æ™‚éŠ·æ¯€æœƒç…§å¸¸é‹ä½œã€‚

        // ç¶å®š Enter
        window.handleKeyPress = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // é˜²æ­¢æ›è¡Œ
                sendMessage();
            }
        }
    </script>
</body>
</html>

